<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Battle</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        a-scene {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }
        
        #battle-ui {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 15px;
            color: white;
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            display: none;
        }
        
        .battle-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        button {
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #4CAF50;
            color: white;
            flex: 1;
        }
        
        button:disabled {
            background: #666;
        }
        
        .hp-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .hp-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.5s;
        }
        
        .enemy-hp .hp-fill {
            background: #f44336;
        }
        
        .battle-log {
            max-height: 80px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false;" 
        vr-mode-ui="enabled: false"
    >
        <a-marker id="hero-marker" preset="hiro">
            <a-box position="0 0.5 0" color="blue"></a-box>
            <a-text value="–†–û–ë–û–¢" position="0 1.2 0" align="center" color="blue"></a-text>
        </a-marker>
        
        <a-marker id="enemy-marker" preset="kanji">
            <a-box position="0 0.5 0" color="red"></a-box>
            <a-text value="–ó–û–ú–ë–ò" position="0 1.2 0" align="center" color="red"></a-text>
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>

    <div id="battle-ui">
        <div class="hp-display">
            <div>–†–æ–±–æ—Ç: <span id="hero-hp">100</span>/100</div>
            <div class="hp-bar">
                <div id="hero-hp-bar" class="hp-fill" style="width: 100%"></div>
            </div>
            
            <div>–ó–æ–º–±–∏: <span id="enemy-hp">100</span>/100</div>
            <div class="hp-bar enemy-hp">
                <div id="enemy-hp-bar" class="hp-fill" style="width: 100%"></div>
            </div>
        </div>
        
        <div class="battle-buttons">
            <button onclick="battle.attack()" id="attack-btn">‚öîÔ∏è –ê—Ç–∞–∫–∞</button>
            <button onclick="battle.defend()" id="defend-btn">üõ°Ô∏è –ó–∞—â–∏—Ç–∞</button>
            <button onclick="battle.heal()" id="heal-btn">‚ù§Ô∏è –õ–µ—á–µ–Ω–∏–µ</button>
        </div>
        
        <div class="battle-log" id="battle-log"></div>
    </div>

    <script>
        class BattleSystem {
            constructor() {
                this.heroHP = 100;
                this.enemyHP = 100;
                this.isBattleActive = false;
                this.isPlayerTurn = true;
                this.heroDefending = false;
            }
            
            attack() {
                if (!this.isPlayerTurn || !this.isBattleActive) return;
                
                const damage = Math.floor(Math.random() * 20) + 10;
                this.enemyHP = Math.max(0, this.enemyHP - damage);
                this.addToLog(`‚öîÔ∏è –†–æ–±–æ—Ç –∞—Ç–∞–∫—É–µ—Ç: ${damage} —É—Ä–æ–Ω–∞!`);
                this.updateUI();
                this.endPlayerTurn();
            }
            
            defend() {
                if (!this.isPlayerTurn || !this.isBattleActive) return;
                
                this.heroDefending = true;
                this.addToLog(`üõ°Ô∏è –†–æ–±–æ—Ç –∑–∞—â–∏—â–∞–µ—Ç—Å—è!`);
                this.endPlayerTurn();
            }
            
            heal() {
                if (!this.isPlayerTurn || !this.isBattleActive) return;
                
                const healAmount = Math.floor(Math.random() * 15) + 10;
                this.heroHP = Math.min(100, this.heroHP + healAmount);
                this.addToLog(`‚ù§Ô∏è –†–æ–±–æ—Ç –ª–µ—á–∏—Ç—Å—è: +${healAmount} HP!`);
                this.updateUI();
                this.endPlayerTurn();
            }
            
            endPlayerTurn() {
                this.isPlayerTurn = false;
                this.disableButtons();
                setTimeout(() => this.enemyTurn(), 1000);
            }
            
            enemyTurn() {
                if (!this.isBattleActive) return;
                
                const enemyAction = Math.random();
                let enemyDamageReduction = this.heroDefending ? 0.5 : 1;
                
                if (enemyAction < 0.6) {
                    const damage = Math.floor((Math.random() * 15 + 5) * enemyDamageReduction);
                    this.heroHP = Math.max(0, this.heroHP - damage);
                    this.addToLog(`üëπ –ó–æ–º–±–∏ –∞—Ç–∞–∫—É–µ—Ç: ${damage} —É—Ä–æ–Ω–∞!`);
                } else if (enemyAction < 0.8) {
                    this.addToLog(`üëπ –ó–æ–º–±–∏ –∑–∞—â–∏—â–∞–µ—Ç—Å—è!`);
                } else {
                    const healAmount = Math.floor(Math.random() * 10) + 5;
                    this.enemyHP = Math.min(100, this.enemyHP + healAmount);
                    this.addToLog(`üëπ –ó–æ–º–±–∏ –ª–µ—á–∏—Ç—Å—è: +${healAmount} HP!`);
                }
                
                this.heroDefending = false;
                this.updateUI();
                this.checkBattleEnd();
                
                if (this.isBattleActive) {
                    this.isPlayerTurn = true;
                    this.enableButtons();
                }
            }
            
            updateUI() {
                document.getElementById('hero-hp').textContent = this.heroHP;
                document.getElementById('enemy-hp').textContent = this.enemyHP;
                document.getElementById('hero-hp-bar').style.width = this.heroHP + '%';
                document.getElementById('enemy-hp-bar').style.width = this.enemyHP + '%';
            }
            
            addToLog(message) {
                const log = document.getElementById('battle-log');
                const entry = document.createElement('div');
                entry.textContent = message;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            }
            
            disableButtons() {
                document.getElementById('attack-btn').disabled = true;
                document.getElementById('defend-btn').disabled = true;
                document.getElementById('heal-btn').disabled = true;
            }
            
            enableButtons() {
                document.getElementById('attack-btn').disabled = false;
                document.getElementById('defend-btn').disabled = false;
                document.getElementById('heal-btn').disabled = false;
            }
            
            checkBattleEnd() {
                if (this.heroHP <= 0) {
                    this.isBattleActive = false;
                    this.addToLog('üíÄ –†–æ–±–æ—Ç –ø–æ–±–µ–∂–¥–µ–Ω!');
                    this.disableButtons();
                } else if (this.enemyHP <= 0) {
                    this.isBattleActive = false;
                    this.addToLog('üéâ –ó–æ–º–±–∏ –ø–æ–±–µ–∂–¥–µ–Ω!');
                    this.disableButtons();
                }
            }
            
            startBattle() {
                if (this.isBattleActive) return;
                
                this.heroHP = 100;
                this.enemyHP = 100;
                this.isBattleActive = true;
                this.isPlayerTurn = true;
                this.heroDefending = false;
                
                document.getElementById('battle-ui').style.display = 'block';
                document.getElementById('battle-log').innerHTML = '';
                this.addToLog('‚öîÔ∏è –ë–∏—Ç–≤–∞ –Ω–∞—á–∞–ª–∞—Å—å!');
                this.updateUI();
                this.enableButtons();
            }
        }
        
        const battle = new BattleSystem();
        
        let heroFound = false;
        let enemyFound = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            
            scene.addEventListener('markerFound', function(e) {
                if (e.target.id === 'hero-marker') {
                    heroFound = true;
                } else if (e.target.id === 'enemy-marker') {
                    enemyFound = true;
                }
                
                if (heroFound && enemyFound && !battle.isBattleActive) {
                    battle.startBattle();
                }
            });
            
            scene.addEventListener('markerLost', function(e) {
                if (e.target.id === 'hero-marker') {
                    heroFound = false;
                } else if (e.target.id === 'enemy-marker') {
                    enemyFound = false;
                }
            });
        });
    </script>
</body>
</html>